<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Опрос</title>
    <link rel="stylesheet" href="css/main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=1.0, user-scalable=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"
          rel="stylesheet">

</head>
<body>
<div class="b_poll ">

    <h3>За каким устройством вы проводите больше времени?</h3>

    <ul>
        <li class="option">
            <span class="counter_meter" style="width: 30%">
            </span>
            <button>
                За персональным компьютером
                <span class="counter">6</span>
            </button>
            <div class="counter_answer">
                <i class="check_mark"></i>
                <span class="counter_pct">30%</span>
            </div>
        </li>

        <li class="option leader">
            <span class="counter_meter" style="width: 20%">
            </span>
            <button>
                За ноутбуком
                <span class="counter">4</span>
            </button>
            <div class="counter_answer">
                <i class="check_mark"></i>
                <span class="counter_pct">20%</span>
            </div>
        </li>

        <li class="option">
            <span class="counter_meter" style="width: 50%">
            </span>
            <button>
                За смартфоном
                <span class="counter">10</span>
            </button>
            <div class="counter_answer">
                <i class="check_mark"></i>
                <span class="counter_pct">50%</span>
            </div>
        </li>

    </ul>
    <footer>
        Проголосовало <span class="counter_all"><b>20</b> человек</span>

    </footer>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>

    let $polls = $('.b_poll');

    function array_sum(array) {

        //** @link https://stackoverflow.com/questions/1230233/how-to-find-the-sum-of-an-array-of-numbers**//
        return array.reduce((a, b) => a + b, 0);
    }

    //** @link https://stackoverflow.com/questions/1669190/find-the-min-max-element-of-an-array-in-javascript //
    Array.prototype.max = function () {
        return Math.max.apply(null, this);
    };

    function declofNum(number, titles) {
        cases = [2, 0, 1, 1, 1, 2];
        return titles[(number % 100 > 4 && number % 100 < 20) ? 2 : cases[(number % 10 < 5) ? number % 10 : 5]];
    }


    $polls.each((index, element) => {
        let $poll = $(element);
        let $buttons = $poll.find('button');

        $buttons.click((event) => {
            let $button = $(event.currentTarget);
            $poll.addClass('show_results');
            $buttons.attr('disabled', true);
            let $option = $button.parents('.option');
            $option.addClass('u_vois');

            let $options = $poll.find('.option');
            let counter = parseInt($option.find('.counter').text()) + 1;
            $option.find('.counter').text(counter);
            let counters = [];

            $options.each((index, element) => {
                let $option = $(element);
                let counter_string = $option.find('.counter').text();
                counter = parseInt(counter_string);
                counters.push(counter);
            });
            let sum_counters = array_sum(counters);

            let word_people = declofNum(sum_counters, ['человек', 'человека', 'человек']);

            $poll.find('.counter_all').html(`<b>${sum_counters}</b> ${word_people}`);
            $options.each((index, element) => {
                let $option = $(element);
                let counter = counters[index];
                let counter_pct = ((counter / sum_counters) * 100).toFixed(2);
                $option.find('.counter_pct').text(`${counter_pct}%`);
                $option.find('.counter_meter').css('width', `${counter_pct}%`);
            });
            let max_counter = counters.max();
            let index_for_max_counter = null;

            counters.forEach((counter, index) => {
                if (index_for_max_counter !== null) {
                    return;
                }
                if (counter === max_counter) {
                    index_for_max_counter = index;
                }
            });
           let $option_with_max_counter = $($options.get(index_for_max_counter));


            $options.removeClass('leader');
            $option_with_max_counter.addClass('leader');


            console.log($options);

        });
    });


</script>
</body>
</html>